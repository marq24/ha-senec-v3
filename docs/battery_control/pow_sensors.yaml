# https://www.home-assistant.io/integrations/template
# https://www.home-assistant.io/docs/configuration/templating/

template:
  - trigger:
      - trigger: state
        entity_id:
          - sensor.tibber_prices
          - sensor.electricity_price_mmphome
          - sensor.senec_battery_charge_percent
          - sensor.energy_production_today_remaining_sum

      - trigger: time_pattern
        hours: "/1"
        minutes: "0"
        seconds: "36"

    sensor:
      - name: "POW last updated"
        unique_id: pow_last_updated
        device_class: timestamp
        state: >
          {% import 'pow_vars.jinja' as i %}
          {{i.update_data()|as_datetime}}

      - name: "POW average price all"
        unique_id: pow_avg_price_all
        state_class: measurement
        unit_of_measurement: "€/kWh"
        state: >
          {% import 'pow_vars.jinja' as i %}
          {% if i.prices_data|length > 0 %}
          {{average(i.prices_data)|round(4)}}
          {% else %}
          {{'None'}}
          {% endif %}

      - name: "POW average price Tibber"
        unique_id: pow_avg_price_tibber
        state_class: measurement
        unit_of_measurement: "€/kWh"
        state: >
          {% import 'pow_vars.jinja' as i %}
          {% if i.tibb_avg_price is not none %}
          {{i.tibb_avg_price}}
          {% else %}
          {{'None'}}
          {% endif %}

      - name: "POW average price from now"
        unique_id: pow_avg_price_from_now
        state_class: measurement
        unit_of_measurement: "€/kWh"
        state: >
          {% import 'pow_vars.jinja' as i %}
          {{i.avgprice_ahead}}

      - name: "POW low price start"
        unique_id: pow_low_price_start
        state_class: measurement
        unit_of_measurement: "Uhr"
        state: >
          {% import 'pow_vars.jinja' as i %}
          {%- if i.low_price_startidx is not none -%}
          {{i.times_data[i.low_price_startidx].strftime('%H')|int}}
          {%- else -%}
          {{'None'}}
          {%- endif -%}

      - name: "POW low price end"
        unique_id: pow_low_price_end
        state_class: measurement
        unit_of_measurement: "Uhr"
        state: >
          {% import 'pow_vars.jinja' as i %}
          {%- if i.low_price_endidx is not none -%}
          {{i.times_data[i.low_price_endidx].strftime('%H')|int+1}}
          {%- else -%}
          {{'None'}}
          {%- endif -%}

      - name: "POW low price duration"
        unique_id: pow_low_price_duration
        state_class: measurement
        unit_of_measurement: "h"
        state: >
          {% import 'pow_vars.jinja' as i %}
          {{i.low_price_duration}}

      - name: "POW cheapest start"
        unique_id: pow_cheapest_start
        state_class: measurement
        unit_of_measurement: "Uhr"
        state: >
          {% import 'pow_vars.jinja' as i %}
          {%- if i.min_price_startidx is not none -%}
          {{i.times_data[i.min_price_startidx].strftime('%H')|int}}
          {%- else -%}
          {{'None'}}
          {%- endif -%}

      - name: "POW cheapest end"
        unique_id: pow_cheapest_end
        state_class: measurement
        unit_of_measurement: "Uhr"
        state: >
          {% import 'pow_vars.jinja' as i %}
          {%- if i.min_price_endidx is not none -%}
          {{i.times_data[i.min_price_endidx].strftime('%H')|int+1}}
          {%- else -%}
          {{'None'}}
          {%- endif -%}

      - name: "POW cheapest duration"
        unique_id: pow_cheapest_duration
        state_class: measurement
        unit_of_measurement: "h"
        state: >
          {% import 'pow_vars.jinja' as i %}
          {{i.min_price_duration}}

      - name: "POW high price start"
        unique_id: pow_high_price_start
        state_class: measurement
        unit_of_measurement: "Uhr"
        state: >
          {% import 'pow_vars.jinja' as i %}
          {%- if i.max_price_startidx is not none -%}
          {{i.times_data[i.max_price_startidx].strftime('%H')|int}}
          {%- else -%}
          {{'None'}}
          {%- endif -%}

      - name: "POW high price end"
        unique_id: pow_high_price_end
        state_class: measurement
        unit_of_measurement: "Uhr"
        state: >
          {% import 'pow_vars.jinja' as i %}
          {%- if i.max_price_endidx is not none -%}
          {{i.times_data[i.max_price_endidx].strftime('%H')|int+1}}
          {%- else -%}
          {{'None'}}
          {%- endif -%}

      - name: "POW high price duration"
        unique_id: pow_high_price_duration
        state_class: measurement
        unit_of_measurement: "h"
        state: >
          {% import 'pow_vars.jinja' as i %}
          {{i.max_price_duration}}

      - name: "POW PV (remaining prod - home usage)]"
        unique_id: pow_pv_remaining_prod_home_usage
        state_class: measurement
        unit_of_measurement: "kWh"
        state: >
          {% import 'pow_vars.jinja' as i %}
          {{i.remain_prod_energy}}

      - name: "POW storage full charge required energy"
        unique_id: pow_storage_full_charge_required_energy
        state_class: measurement
        unit_of_measurement: "kWh"
        state: >
          {% import 'pow_vars.jinja' as i %}
          {{i.storage_need}}

      - name: "POW storage full charge duration"
        unique_id: pow_storage_full_charge_duration
        state_class: measurement
        unit_of_measurement: "h"
        state: >
          {% import 'pow_vars.jinja' as i %}
          {{i.storage_full_charge_duration}}

      - name: "POW available energy duration [storage + PV (remaining - home usage)]"
        unique_id: pow_available_energy_duration_storage_pv_remaining_home_usage
        state_class: measurement
        unit_of_measurement: "h"
        state: >
          {% import 'pow_vars.jinja' as i %}
          {{i.max_energy_duration}}

    binary_sensor:
      - name: "POW PV power can fully load storage"
        unique_id: pow_pv_power_can_fully_load_storage
        state: >
          {% import 'pow_vars.jinja' as i %}
          {%- if i.storage_need > 0 and (i.remain_prod_energy) > i.storage_need -%}
          {{'on'}}
          {%- else -%}
          {{'off'}}
          {%- endif -%}

      - name: "POW now in low price phase"
        unique_id: pow_now_in_low_price_phase
        state: >
          {% import 'pow_vars.jinja' as i %}
          {%- if i.low_price_startidx is not none and i.low_price_endidx is not none and (i.low_price_startidx <= i.now_idx <= i.low_price_endidx) -%}
          {{'on'}}
          {%- else -%}
          {{'off'}}
          {%- endif -%}

      - name: "POW now in cheapest phase"
        unique_id: pow_now_in_cheapest_phase
        state: >
          {% import 'pow_vars.jinja' as i %}
          {%- if i.min_price_endidx is not none and i.min_price_startidx is not none -%}
            {%- if i.min_price_startidx <= i.now_idx <= i.min_price_endidx -%}
          {{'on'}}
            {%- else -%}
          {{'off'}}
            {%- endif -%}
          {%- else -%}
          {{'off'}}
          {%- endif -%}

      - name: "POW now in high price phase"
        unique_id: pow_now_in_high_price_phase
        state: >
          {% import 'pow_vars.jinja' as i %}
          {%- if i.max_price_endidx is not none and i.max_price_startidx is not none -%}
            {%- if i.max_price_startidx <= i.now_idx <= i.max_price_endidx -%}
          {{'on'}}
            {%- else -%}
          {{'off'}}
            {%- endif -%}
          {%- else -%}
          {{'off'}}
          {%- endif -%}